<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:jt="http://www.w3.org/1999/xhtml">

<head>
<title></title>
<template th:substituteby="framework/pageset.html"></template>
<script th:src="@{/jt/app/appcommon.js}"></script>
</head>
<body>
	<div id="app" view>
	
	<hy-filllayout rows="toolh,180,*" :showborder="true"  :showpadding="false">
			<hy-fillarea :display="areaVisible">
				<template th:substituteby="jt/app/appbutton.html"></template>
			</hy-fillarea>
			<hy-fillarea title="审批结果">
				<hy-form id="myform" name="dataWrap" style="width:95%"
					labelposition="right" :labelwidth="120" :readonly="editFlag=='N'"
					label-suffix="：" :cols="1" size="normal"> 
						<hy-forminput label="工作单号"  name="appNo" :rules="{required: true}" :readonly="true" ></hy-forminput>
						<hy-formradio  label="是否同意" dataprovider="UEP.YES_OR_NO"  name="agreeFlag"  :rules="{required: true}" ></hy-formradio>
						<hy-forminput label="审批意见"  name="verifyOpinion" :rowspan="2" :colspan="2" type="textarea" :placeholder="verifyContent"
  							:icontype="icontypeId"  @iconclick="searchTemplate"></hy-forminput>
				</hy-form> 
		    </hy-fillarea>
		    <hy-fillarea title="审批详情" :display="detailVisible">
				<hy-filllayout id="detailFrame" cols="200,*">
					<hy-fillarea>
						<hy-tree id="hisTaskTree" @nodeclick="changeHisDetail" :dynamic="true" :rootcode="rootcode"
				  			valueprovider="com.haiyisoft.jt.app.tree.HisAppTaskTree"  ></hy-tree>
					</hy-fillarea>
					<hy-fillarea id="hisDetailId" :href="detailHref"></hy-fillarea>
				</hy-filllayout>
			</hy-fillarea>
		</hy-filllayout>
	</div>
	<script th:inline="javascript">
		var vm = new Vue({
			el : "#app",
			data : {
				areaVisible : "block",
				detailVisible : "none",
				detailHref : "",
				verifyContent:"单击图标选择模版信息",
				icontypeId :"icon-link",
				rootcode : ""
			},
			mounted : function(){
				myform.setRecord(response.getAjaxDataWrap("dataWrap").getData()) ;
				confirmTask = response.getParameter("confirmTask");
				this.detailVisible="block";
				if(editFlag=='N'){
					this.verifyContent = '';
					this.icontypeId = '';
				}
				this.rootcode = this.appInstanceId+","+this.appTaskId;
			},
			methods : {				
				save : function(){
					myform.validate(function(data){
						if(data){
							var formData = myform.collectData();
							var dataArr = [];
							dataArr.push(formData);
							$.request({
								url : $$pageContextPath + 'jt/app/appApproval/save',
								data : dataArr,
								success : vm.saveSuccess
							});	
						}	
					});
				},
				saveSuccess : function(response) {
// 					setRM(function(){$.close('')})
					setRM(function(){})
				},
	 			searchTemplate : function() {
	 				var templateContent = myform.getRecord().data.verifyOpinion;
	 				$.popWindow({
						url:$$pageContextPath + 'jt/app/selecttexttemplate/?templateType=1' + '&templateContent='+templateContent,
						title: "选择模板",	
						callback: vm.callback,
						arguments:response,
						css:{width:600,height:400}, 
						button:0,
						isRunCallback :true
					});
	 			},
	 			callback : function(response) {
	 				myform.getRecord().set("verifyOpinion",response);
	 			},
	 			changeHisDetail : function(obj) {
	 				this.detailHref = obj.type;
	 			},
	 			appReturnTask : function(){
	 				$.confirm("确认", "确定要将工单退回？", returnTask);
	 			},
	 			returnTask : function() {
	 				//工单退回加理由
	 				$.showModalDialog($$pageContextPath+"jt/app/appSendAdvice/?sendType=2&instanceId=" +appInstanceId + "&taskId=" + appTaskId, "退回理由", 
	 					function() {
	 						goWithButton("returnTask");
	 					}, null, 500, 180, 0)
	 			},
	 			
			}

			
		});
		function normalSend(){
			vm.save(function(){
				$.request({
					url : $$pageContextPath + 'jt/app/common/normalSend',
					params : {"appInstanceId" : vm.appInstanceId,
							  "appTaskId" : vm.appTaskId},
				    success : flowOverBack
				});	
			})
			
		}
	</script>
</body>
</html>